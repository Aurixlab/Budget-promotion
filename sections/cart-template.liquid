{% comment %}
  ** Cart page - Clean version with 5 item maximum limit **
{% endcomment %}

<div class="container main content">
  <a name="pagecontent" id="pagecontent"></a>

  <div class="section clearfix">
    <div class="sixteen columns">
      <h1>{{ 'cart.general.title' | t }}</h1>
      <div class="feature_divider"></div>
    </div>
  </div>

  {% comment %}
    Cart Logic - Check for custom items (pricing already in variants)
  {% endcomment %}
  {% assign cart_has_custom_items = false %}

  {% for item in cart.items %}
    {% if item.properties._custom_order == 'Yes' or item.properties['üé® Custom Order'] %}
      {% assign cart_has_custom_items = true %}
    {% endif %}
  {% endfor %}

  {% comment %}
    ** CART LIMIT CHECK - Maximum 5 items **
    Count unique products, not line items (to avoid double-counting custom products with back view)
  {% endcomment %}
  {% assign cart_limit = 5 %}
  {% assign cart_limit_exceeded = false %}
  {% assign unique_product_ids = '' %}
  {% assign unique_product_count = 0 %}
  
  {% for item in cart.items %}
    {% assign product_id_str = item.product_id | append: '|' %}
    {% unless unique_product_ids contains product_id_str %}
      {% assign unique_product_ids = unique_product_ids | append: product_id_str %}
      {% assign unique_product_count = unique_product_count | plus: 1 %}
    {% endunless %}
  {% endfor %}
  
  {% if unique_product_count > cart_limit %}
    {% assign cart_limit_exceeded = true %}
  {% endif %}

  {% if cart.item_count == 0 %}
    <div class="sixteen columns">
      <div class="section clearfix cart-empty">
        <div class="six columns offset-by-five medium-down--one-whole">
          <p class="quote">{{ 'cart.general.continue_browsing_html' | t }}</p>
          <a href="/collections/all" class="action_button continue-button add_to_cart">
            {{- 'cart.general.continue_shopping_link_html' | t -}}
          </a>
        </div>
        <br class="clear">
      </div>
    </div>
  {% else %}
    {% comment %}
      ** Display cart limit warning/error **
    {% endcomment %}
    {% if unique_product_count >= cart_limit %}
      <div class="sixteen columns">
        <div class="cart-limit-notice {% if cart_limit_exceeded %}cart-limit-error{% else %}cart-limit-warning{% endif %}">
          <span class="notice-icon">{% if cart_limit_exceeded %}‚ö†Ô∏è{% else %}‚ÑπÔ∏è{% endif %}</span>
          <div class="notice-content">
            {% if cart_limit_exceeded %}
              <strong>Cart Limit Exceeded!</strong>
              <p>You have {{ unique_product_count }} unique products in your cart. Maximum allowed is {{ cart_limit }} items. Please remove {{ unique_product_count | minus: cart_limit }} product(s) to proceed with checkout.</p>
            {% else %}
              <strong>Cart Limit Reached</strong>
              <p>You have reached the maximum of {{ cart_limit }} unique products in your cart. Remove a product to add more.</p>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}

    <form action="/cart" method="post" id="cart_form" novalidate>
      <div class="section clearfix">
        <div class="sixteen columns medium-down--one-whole">
          {% for item in cart.items %}
            {% assign is_custom_product = false %}
            {% assign custom_color = '' %}
            {% assign custom_size = '' %}
            {% assign back_view_option = 'No' %}
            {% assign customization_count = 0 %}
            {% assign design_data = null %}
            {% assign custom_design_front = '' %}
            {% assign custom_design_back = '' %}

            {% if item.variant %}
              {% assign custom_color = item.variant.option1 %}
              {% assign custom_size = item.variant.option2 %}
              {% assign back_view_option = item.variant.option3 | default: 'No' %}
            {% endif %}

            {% for property in item.properties %}
              {% if property.first == '_custom_order' and property.last == 'Yes' %}
                {% assign is_custom_product = true %}
              {% elsif property.first == '_customization_count' %}
                {% assign customization_count = property.last | plus: 0 %}
              {% elsif property.first == '_custom_design_front' %}
                {% assign custom_design_front = property.last %}
              {% elsif property.first == '_custom_design_back' %}
                {% assign custom_design_back = property.last %}
              {% elsif property.first == '_design_data' and property.last != blank %}
                {% assign design_data = property.last | parse_json %}
              {% endif %}
            {% endfor %}

            {% assign per_item_price = item.original_price %}
            {% assign item_total = per_item_price | times: item.quantity %}

            <div class="cart-item-block {% if is_custom_product %}custom-product-item{% endif %} {% if back_view_option != 'No' %}back-view-addon{% endif %}">
              <div class="item-header">
                <div class="item-image">
                  <img src="{{ item.image | img_url: 'medium' }}" alt="{{ item.title | escape }}">

                  {% if custom_design_front != blank or custom_design_back != blank %}
                    <div class="custom-previews">
                      {% if custom_design_front != blank %}
                        <div class="preview-thumb">
                          <img src="{{ custom_design_front }}" alt="Front Design" class="preview-image">
                          <div class="preview-label">Front</div>
                        </div>
                      {% endif %}
                      {% if custom_design_back != blank %}
                        <div class="preview-thumb">
                          <img src="{{ custom_design_back }}" alt="Back Design" class="preview-image">
                          <div class="preview-label">Back</div>
                        </div>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>

                <div class="item-details">
                  <div class="item-title-section">
                    <h3>
                      <a href="{{ item.product.url }}" class="product-link">
                        {{ item.product.title }}
                        {% if is_custom_product %}
                          <span class="custom-badge">Custom</span>
                        {% endif %}
                        {% if back_view_option != 'Front Design Only' %}
                          <span class="addon-badge">Back View</span>
                        {% endif %}
                      </a>
                    </h3>

                    <div class="meta">
                      {% if custom_color != blank %}
                        <span>Color: {{ custom_color }}</span> |
                      {% endif %}
                      {% if custom_size != blank %}
                        <span>Size: {{ custom_size }}</span> |
                      {% endif %}
                      <span>Price: {{ per_item_price | money }}</span>
                    </div>
                  </div>

                  <div class="quantity-display-row">
                    <span class="quantity-label">Quantity:</span>
                    <span class="quantity-value">{{ item.quantity }}</span>
                  </div>

                  {% if design_data %}
                    <div class="custom-details">
                      <div class="detail-row">
                        <span class="detail-label">Color:</span>
                        <span class="detail-value">{{ custom_color }}</span>
                      </div>

                      <div class="detail-row">
                        <span class="detail-label">Size:</span>
                        <span class="detail-value">{{ custom_size }}</span>
                      </div>

                      {% if design_data %}
                        <div class="detail-row">
                          <span class="detail-label">Customizations:</span>
                          <span class="detail-value">
                            {%- if custom_design_front != blank and custom_design_back != blank -%}
                              Front & Back Both
                            {%- elsif custom_design_front != blank -%}
                              Front Only
                            {%- elsif custom_design_back != blank -%}
                              Back Only
                            {%- else -%}
                              {{ customization_count }} layers
                            {%- endif -%}
                          </span>
                        </div>
                      {% endif %}

                      <div class="detail-row">
                        <span class="detail-label">Price Includes:</span>
                        <span class="detail-value">
                          Base +
                          {% if back_view_option != 'No' and back_view_option != 'Front Design Only' %}
                            Back View ($20)
                          {% else %}
                            Front Only
                          {% endif %}
                        </span>
                      </div>
                    </div>

                    {% if design_data.layers %}
                      <div class="layer-details">
                        <h5>Design Layers:</h5>
                        <ul class="layer-list">
                          {% for layer in design_data.layers %}
                            <li class="layer-item">
                              <span class="layer-icon">‚Ä¢</span>
                              <span>{{ layer.type | default: 'Element' }} - {{ layer.text | default: 'Custom' }}</span>
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>

              <div class="item-footer">
                <div class="item-subtotal">
                  <span class="subtotal-label">Subtotal:</span>
                  <span class="subtotal-value">{{ item_total | money }}</span>
                </div>

                <button type="button" class="remove-item-btn" data-line-id="{{ item.key }}">
                  <span class="icon-remove"></span> Remove
                </button>

                <input
                  type="hidden"
                  name="updates[{{ item.key }}]"
                  value="{{ item.quantity }}"
                  id="updates_{{ item.key }}"
                  data-line-id="{{ item.key }}"
                >
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="section clearfix">
        <div class="sms-total-wrapper">
          <div class="cart-totals">
            <div class="cart-item-count-display">
              <span class="item-count-label">Unique Products in cart:</span>
              <span class="item-count-value {% if cart_limit_exceeded %}limit-exceeded{% elsif unique_product_count == cart_limit %}limit-reached{% endif %}">
                {{ unique_product_count }} / {{ cart_limit }}
              </span>
            </div>

            <div class="subtotal-line">
              <span class="label">Subtotal:</span>
              <span class="value money">{{ cart.total_price | money }}</span>
            </div>

            <div class="total-line">
              <span class="label">Total</span>
              <span class="value money" style="color: #FF741C;">{{ cart.total_price | money }}</span>
            </div>

            <p style="font-size: 13px; color: #666; margin-top: 10px; font-style: italic;">
              * All customization fees are included in item prices
            </p>

            {% if settings.show_multiple_currencies %}
              <p class="currency-note">
                <small>
                  {{ 'cart.general.orders_processed_in_currency_html' | t: currency: shop.currency }}
                </small>
              </p>
            {% endif %}

            {% if section.settings.display_special_instructions %}
              <div class="special-instructions">
                <label for="note">Order Notes (especially for custom designs):</label>
                <textarea
                  id="note"
                  name="note"
                  rows="3"
                  placeholder="Add any special instructions..."
                >{{ cart.note }}</textarea>
                <p style="font-size: 12px; color: #999; margin-top: 5px;">
                  ‚ö†Ô∏è Orders placed after 11:00 AM will be processed the following business day
                </p>
              </div>
            {% endif %}

            {% if section.settings.display_tos_checkbox %}
              <div class="terms-checkbox">
                <input type="checkbox" class="tos_agree" id="cart_agree" required>
                <label class="tos_label" for="cart_agree">
                  {{ 'cart.general.agree_to_terms_html' | t }}
                </label>
              </div>
            {% endif %}

            <div class="checkout-actions {% if cart_limit_exceeded %}checkout-disabled{% endif %}">
              <button 
                type="submit" 
                class="action_button add_to_cart {% if cart_limit_exceeded %}disabled{% endif %}" 
                id="checkout" 
                name="checkout"
                {% if cart_limit_exceeded %}disabled{% endif %}
              >
                {% if settings.show_lock_icon %}<span class="icon-lock"></span>{% endif %}
                <span class="btn-text">
                  {% if cart_limit_exceeded %}
                    üö´ Remove Items to Checkout
                  {% else %}
                    {{ 'cart.general.checkout' | t }}
                  {% endif %}
                </span>
              </button>

              {% if content_for_additional_checkout_buttons %}
                <div class="additional-checkout-buttons {% if cart_limit_exceeded %}disabled{% endif %}" id="dynamic-checkout-buttons">
                  {{ content_for_additional_checkout_buttons }}
                </div>
              {% endif %}
              
              {% if cart_limit_exceeded %}
                <p class="checkout-disabled-message">
                  ‚ö†Ô∏è Checkout is disabled. Please remove {{ unique_product_count | minus: cart_limit }} product(s) to continue.
                </p>
              {% endif %}
            </div>

            <div class="continue-shopping">
              <a href="/collections/all" class="secondary_button">
                {{ 'cart.general.continue_shopping_link_html' | t }}
              </a>
            </div>
          </div>
        </div>
      </div>
    </form>

    {% include 'cart-shipping-calculator' %}
  {% endif %}
</div>

<style>
  div#shopify-section-cart-template .container.main.content {
      max-width: 1400px;
      width: 100%;
      padding: 20px;
  }
  form#cart_form {
      display: grid;
      flex-direction: row;
      justify-content: space-between;
      gap: 40px;
      grid-template-columns: 2fr 1fr;
      padding-top: 30px;
  }

  /* Cart Limit Notice Styles */
  .cart-limit-notice {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid;
      animation: slideIn 0.3s ease-out;
  }
  .cart-limit-warning {
      background: #fff8e6;
      border-color: #ffa500;
      color: #996300;
  }
  .cart-limit-error {
      background: #ffe6e6;
      border-color: #ff4444;
      color: #990000;
  }
  .cart-limit-notice .notice-icon {
      font-size: 24px;
      line-height: 1;
  }
  .cart-limit-notice .notice-content {
      flex: 1;
  }
  .cart-limit-notice strong {
      display: block;
      margin-bottom: 5px;
      font-size: 16px;
  }
  .cart-limit-notice p {
      margin: 0;
      font-size: 14px;
  }
  @keyframes slideIn {
      from {
          opacity: 0;
          transform: translateY(-10px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }

  /* Cart Item Count Display */
  .cart-item-count-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f5f5f5;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 2px solid #e0e0e0;
  }
  .item-count-label {
      font-weight: 600;
      color: #666;
      font-size: 14px;
  }
  .item-count-value {
      font-weight: 700;
      font-size: 16px;
      color: #333;
      background: #fff;
      padding: 4px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
  }
  .item-count-value.limit-reached {
      color: #ffa500;
      border-color: #ffa500;
      background: #fff8e6;
  }
  .item-count-value.limit-exceeded {
      color: #ff4444;
      border-color: #ff4444;
      background: #ffe6e6;
      animation: pulse 1s infinite;
  }
  @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
  }

  .cart-item-block {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s ease;
  }
  .cart-item-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }
  .custom-product-item {
      border-left: 4px solid #FF741C;
      background: #fff9f5;
  }
  .back-view-addon {
      border-left: 4px solid #FF9E00;
      background: #fffaf5;
      opacity: 0.9;
  }
  .custom-badge, .addon-badge {
      display: inline-block;
      background: linear-gradient(135deg, #FF741C, #FF9E00);
      color: #fff;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 10px;
      box-shadow: 0 2px 6px rgba(255, 116, 28, 0.3);
  }
  .addon-badge {
      background: linear-gradient(135deg, #FF9E00, #FFB84D);
  }
  .item-header {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      align-items: flex-start;
  }
  .item-image {
      flex: 0 0 100px;
      position: relative;
  }
  .item-image img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
  }
  .custom-previews {
      display: flex;
      gap: 8px;
      margin-top: 10px;
  }
  .preview-thumb {
      position: relative;
      flex: 1;
      border: 2px solid #FF741C;
      border-radius: 6px;
      overflow: hidden;
      background: #f9f9f9;
  }
  .preview-thumb img.preview-image {
      width: 100%;
      height: 60px;
      object-fit: contain;
      display: block;
      background: #fff;
  }
  .preview-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 116, 28, 0.9);
      color: white;
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      padding: 2px;
  }
  .item-details {
      flex: 1;
  }
  .item-title-section h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
  }
  .item-title-section .meta {
      font-size: 14px;
      color: #666;
      margin: 5px 0;
  }
  .quantity-display-row {
      margin-bottom: 12px;
      font-size: 14px;
  }
  .quantity-label {
      color: #666;
      font-weight: 500;
  }
  .quantity-value {
      color: #000;
      font-weight: 700;
      background: #f0f0f0;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 5px;
  }
  .custom-details {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 3px solid #FF741C;
  }
  .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 13px;
      line-height: 1.4;
  }
  .detail-label {
      color: #666;
      font-weight: 500;
  }
  .detail-value {
      color: #000;
      font-weight: 600;
  }
  .detail-value.highlight {
      color: #FF741C;
      font-weight: 700;
  }
  .layer-details {
      margin-top: 10px;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 6px;
      border: 1px solid #ddd;
  }
  .layer-details h5 {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #666;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
  }
  .layer-list {
      list-style: none;
      padding: 0;
      margin: 0;
  }
  .layer-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      font-size: 12px;
      color: #555;
  }
  .item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid #eee;
  }
  .item-subtotal .subtotal-value {
      font-size: 18px;
      font-weight: 700;
      color: #FF741C;
  }
  .remove-item-btn {
      background: none;
      border: 1px solid #FF741C;
      color: #FF741C;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s ease;
  }
  .remove-item-btn:hover {
      background: #FF741C;
      color: #fff;
  }
  .cart-totals {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .total-line {
      font-size: 18px;
      font-weight: 700;
      border-top: 2px solid #ddd;
      padding-top: 10px;
      margin-top: 10px;
  }
  .total-line .value {
      color: #FF741C;
  }

  /* Disabled checkout button */
  button.action_button.disabled,
  button.action_button:disabled {
      background: #ccc !important;
      color: #666 !important;
      cursor: not-allowed !important;
      opacity: 0.6;
      border: 2px solid #999 !important;
  }
  button.action_button.disabled:hover,
  button.action_button:disabled:hover {
      background: #ccc !important;
      transform: none !important;
  }
  
  .checkout-actions.checkout-disabled {
      opacity: 0.6;
      pointer-events: none;
      position: relative;
  }
  
  .checkout-disabled-message {
      background: #ffe6e6;
      border: 2px solid #ff4444;
      color: #990000;
      padding: 12px 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-weight: 600;
      font-size: 14px;
      text-align: center;
      animation: shake 0.5s ease-in-out;
  }
  
  @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
  }
  
  .additional-checkout-buttons.disabled {
      opacity: 0.5;
      pointer-events: none;
      filter: grayscale(100%);
  }
  
  .additional-checkout-buttons.disabled::after {
      content: "Disabled - Remove items first";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 68, 68, 0.95);
      color: white;
      padding: 8px 15px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
      z-index: 10;
  }

  @media (max-width: 768px) {
      .item-header {
          flex-direction: column;
      }
      .item-image {
          flex: 0 0 auto;
          text-align: center;
      }
      .item-footer {
          flex-direction: column;
          gap: 10px;
          align-items: flex-start;
      }
      form#cart_form {
          gap: 20px;
          grid-template-columns: 1fr;
      }
      .cart-limit-notice {
          flex-direction: column;
          gap: 10px;
      }
  }
</style>

<script>
  (function () {
    'use strict';

    const CART_LIMIT = 5;

    // Function to count unique products in cart (not line items)
    function getUniqueProductCount() {
      const itemInputs = document.querySelectorAll('input[type="hidden"][name^="updates"]');
      const uniqueProducts = new Set();
      
      itemInputs.forEach((input) => {
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
          // Extract product identifier from the parent cart item block
          const cartBlock = input.closest('.cart-item-block');
          if (cartBlock) {
            // Use data attribute or find product link to get unique product ID
            const productLink = cartBlock.querySelector('.product-link');
            if (productLink) {
              const productUrl = productLink.getAttribute('href');
              if (productUrl) {
                uniqueProducts.add(productUrl);
              }
            }
          }
        }
      });
      
      return uniqueProducts.size;
    }
    
    // Fallback: count total line items (for compatibility)
    function getCartItemCount() {
      const itemInputs = document.querySelectorAll('input[type="hidden"][name^="updates"]');
      let totalCount = 0;
      itemInputs.forEach((input) => {
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
          totalCount += 1; // Count each line item as 1
        }
      });
      return totalCount;
    }

    // Function to disable all checkout actions
    function disableCheckout() {
      const checkoutButton = document.getElementById('checkout');
      const checkoutActions = document.querySelector('.checkout-actions');
      const dynamicCheckoutButtons = document.getElementById('dynamic-checkout-buttons');
      
      if (checkoutButton) {
        checkoutButton.disabled = true;
        checkoutButton.classList.add('disabled');
        checkoutButton.style.pointerEvents = 'none';
      }
      
      if (checkoutActions) {
        checkoutActions.classList.add('checkout-disabled');
      }
      
      if (dynamicCheckoutButtons) {
        dynamicCheckoutButtons.classList.add('disabled');
        const buttons = dynamicCheckoutButtons.querySelectorAll('button, input[type="submit"], a');
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.style.opacity = '0.5';
          btn.style.cursor = 'not-allowed';
          btn.style.pointerEvents = 'none';
          
          // Prevent clicks
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            alert('Please remove products from your cart. Maximum allowed is ' + CART_LIMIT + ' unique products.');
            return false;
          }, true);
        });
      }
    }

    // Check cart limit on page load
    const initialProductCount = getUniqueProductCount();
    if (initialProductCount > CART_LIMIT) {
      disableCheckout();
    }

    // Validate cart before form submission
    const cartForm = document.getElementById('cart_form');
    if (cartForm) {
      cartForm.addEventListener('submit', function (e) {
        const productCount = getUniqueProductCount();
        
        if (productCount > CART_LIMIT) {
          e.preventDefault();
          e.stopPropagation();
          alert(`‚ùå CHECKOUT DISABLED\n\nYou have ${productCount} unique products in your cart.\nMaximum allowed is ${CART_LIMIT} products.\n\nPlease remove ${productCount - CART_LIMIT} product(s) to proceed with checkout.`);
          return false;
        }

        // Check terms checkbox if enabled
        const tosCheckbox = document.getElementById('cart_agree');
        if (tosCheckbox && !tosCheckbox.checked) {
          e.preventDefault();
          alert('Please agree to the terms and conditions.');
          return false;
        }
      });
      
      // Prevent any form submission attempts
      cartForm.addEventListener('submit', function(e) {
        const productCount = getUniqueProductCount();
        if (productCount > CART_LIMIT) {
          e.preventDefault();
          e.stopImmediatePropagation();
          return false;
        }
      }, true);
    }

    // Remove item buttons
    const removeButtons = document.querySelectorAll('.remove-item-btn');
    removeButtons.forEach((button) => {
      button.addEventListener('click', function () {
        const lineId = this.dataset.lineId;
        if (confirm('Remove this item from cart?')) {
          const input = document.querySelector(`input[type="hidden"][data-line-id="${lineId}"]`);
          if (input) {
            input.value = 0;
            document.getElementById('cart_form').submit();
          }
        }
      });
    });

    // Preview images error handling
    document.querySelectorAll('.preview-image').forEach((img) => {
      img.addEventListener('error', function () {
        this.style.display = 'none';
        this.parentElement.innerHTML = '<span style="color: #999; font-size: 10px;">Preview unavailable</span>';
      });
    });

    // Extra protection: Intercept all checkout button clicks
    document.addEventListener('click', function(e) {
      const productCount = getUniqueProductCount();
      if (productCount > CART_LIMIT) {
        const target = e.target.closest('button[name="checkout"], .shopify-payment-button__button, [data-shopify="payment-button"]');
        if (target) {
          e.preventDefault();
          e.stopPropagation();
          alert(`‚ùå CHECKOUT DISABLED\n\nYou have ${productCount} unique products in your cart.\nMaximum allowed is ${CART_LIMIT} products.\n\nPlease remove ${productCount - CART_LIMIT} product(s) first.`);
          return false;
        }
      }
    }, true);

    // Disable checkout actions on page load if needed
    window.addEventListener('load', function() {
      const productCount = getUniqueProductCount();
      if (productCount > CART_LIMIT) {
        disableCheckout();
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Cart page",
  "class": "cart-section",
  "settings": [
    {
      "type": "checkbox",
      "id": "display_special_instructions",
      "label": "Show note text box"
    },
    {
      "type": "checkbox",
      "id": "display_tos_checkbox",
      "label": "Show agree to terms checkbox"
    },
    {
      "type": "checkbox",
      "id": "display_savings",
      "label": "Show total savings",
      "default": true
    },
    {
      "type": "radio",
      "id": "collection_style",
      "label": "Collection layout",
      "default": "grid",
      "options": [
        { "value": "slider", "label": "Slider" },
        { "value": "grid", "label": "Grid" }
      ]
    },
    {
      "type": "richtext",
      "id": "cart_message",
      "label": "Cart message"
    }
  ],
  "blocks": [
    {
      "type": "featured_collection",
      "name": "Featured collection",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Heading",
          "default": "You may also be interested in"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "range",
          "id": "products_limit",
          "label": "Limit products",
          "min": 2,
          "max": 50,
          "step": 1,
          "default": 6
        }
      ]
    }
  ]
}
{% endschema %}

<script src="https://node1.itoris.com/dpo/storefront/include.js?shop={{ shop.permanent_domain }}"></script>
